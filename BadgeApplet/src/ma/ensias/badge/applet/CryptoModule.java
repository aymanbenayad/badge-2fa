package ma.ensias.badge.applet;

import javacard.framework.*;
import javacard.security.*;
import javacardx.crypto.*;

public class CryptoModule {

    private RSAPublicKey rsaPublicKey;
    private Cipher rsaCipher;

    private static final byte[] RSA_MOD = { (byte)0xD7, (byte)0xA8, (byte)0xC3, (byte)0xFC, (byte)0xAD, (byte)0xEF, (byte)0x31, (byte)0x70, (byte)0x35, (byte)0x1D, (byte)0x41, (byte)0x60, (byte)0x14, (byte)0x7B, (byte)0x37, (byte)0x6B, (byte)0x8F, (byte)0x8D, (byte)0xC0, (byte)0x33, (byte)0x94, (byte)0xED, (byte)0x5A, (byte)0x77, (byte)0x36, (byte)0x6A, (byte)0xF4, (byte)0xC4, (byte)0xFD, (byte)0xE3, (byte)0xAF, (byte)0xBE, (byte)0xD3, (byte)0x80, (byte)0x15, (byte)0xC0, (byte)0x3F, (byte)0xCD, (byte)0x31, (byte)0xDA, (byte)0xFF, (byte)0x1E, (byte)0xD0, (byte)0xE8, (byte)0x67, (byte)0x08, (byte)0x1F, (byte)0xE1, (byte)0x52, (byte)0x86, (byte)0xED, (byte)0x84, (byte)0xF7, (byte)0xA7, (byte)0x9B, (byte)0x8C, (byte)0x3F, (byte)0x2A, (byte)0x1B, (byte)0x28, (byte)0x01, (byte)0x68, (byte)0xC3, (byte)0x01, (byte)0x64, (byte)0x72, (byte)0x8D, (byte)0xF5, (byte)0xFB, (byte)0x08, (byte)0xB9, (byte)0xF2, (byte)0x7D, (byte)0xD2, (byte)0xAE, (byte)0xEC, (byte)0x81, (byte)0xE9, (byte)0xFD, (byte)0x8E, (byte)0x20, (byte)0x3A, (byte)0x21, (byte)0x65, (byte)0xC6, (byte)0x64, (byte)0xFE, (byte)0x27, (byte)0x07, (byte)0x71, (byte)0x24, (byte)0x6E, (byte)0x62, (byte)0xA8, (byte)0x78, (byte)0xE3, (byte)0xAA, (byte)0x8A, (byte)0xC1, (byte)0x73, (byte)0xA8, (byte)0xC1, (byte)0x7E, (byte)0xE7, (byte)0x3E, (byte)0xE4, (byte)0x68, (byte)0xE2, (byte)0x30, (byte)0xF5, (byte)0xCC, (byte)0x7A, (byte)0x38, (byte)0x4C, (byte)0x80, (byte)0x4A, (byte)0x4C, (byte)0x95, (byte)0x48, (byte)0xBE, (byte)0x01, (byte)0xFA, (byte)0x12, (byte)0xD9, (byte)0xA9, (byte)0x9C, (byte)0xC5, (byte)0x6F };
    private static final byte[] RSA_EXP = { (byte)0x01, (byte)0x00, (byte)0x01 };

    public CryptoModule() {
        rsaPublicKey = (RSAPublicKey) KeyBuilder.buildKey(KeyBuilder.TYPE_RSA_PUBLIC, KeyBuilder.LENGTH_RSA_1024, false);
        
        rsaPublicKey.setModulus(RSA_MOD, (short) 0, (short) RSA_MOD.length);
        rsaPublicKey.setExponent(RSA_EXP, (short) 0, (short) RSA_EXP.length);

        rsaCipher = Cipher.getInstance(Cipher.ALG_RSA_PKCS1, false);
    }

    public short encryptChallenge(byte[] inBuf, short inOff, short inLen, byte[] outBuf, short outOff) {
        rsaCipher.init(rsaPublicKey, Cipher.MODE_ENCRYPT);
        return rsaCipher.doFinal(inBuf, inOff, inLen, outBuf, outOff);
    }
}